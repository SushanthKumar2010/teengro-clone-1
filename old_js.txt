/*********************************************************
 * CHAT CONFIG (your existing chat logic – unchanged)
 *********************************************************/

// Backend URL (Render)
const backendBaseUrl = "https://new-try-zfki.onrender.com";

// DOM elements (chat UI)
const classLevelSelect = document.getElementById("classLevel");
const subjectSelect = document.getElementById("subject");
const chapterSelect = document.getElementById("chapter");
const questionInput = document.getElementById("questionInput");
const sendBtn = document.getElementById("sendBtn");
const chatWindow = document.getElementById("chatWindow");

// Optional form
const questionForm = document.getElementById("questionForm");
const responseDiv = document.getElementById("response");

// Chapter list
const CHAPTERS = {
  Maths: [
    "Commercial Mathematics",
    "Algebra",
    "Geometry",
    "Mensuration",
    "Trigonometry"
  ],
  Physics: [
    "Force, Work, Power and Energy",
    "Light",
    "Sound",
    "Electricity and Magnetism",
    "Heat",
    "Modern Physics"
  ],
};

function populateChapters() {
  if (!subjectSelect || !chapterSelect) return;
  const subject = subjectSelect.value;
  chapterSelect.innerHTML = "";
  CHAPTERS[subject]?.forEach(ch => {
    const opt = document.createElement("option");
    opt.value = ch;
    opt.textContent = ch;
    chapterSelect.appendChild(opt);
  });
}

if (subjectSelect) {
  subjectSelect.addEventListener("change", populateChapters);
  populateChapters();
}

function appendMessage(role, text, meta) {
  if (!chatWindow) return;

  const row = document.createElement("div");
  row.classList.add("message-row", role);

  const bubble = document.createElement("div");
  bubble.classList.add("message-bubble");

  if (role === "bot" && meta) {
    const metaDiv = document.createElement("div");
    metaDiv.classList.add("meta-text");
    metaDiv.textContent = `${meta.class_level} • ${meta.subject} • ${meta.chapter}`;
    bubble.appendChild(metaDiv);
  }

  const p = document.createElement("div");
  p.innerText = text;
  bubble.appendChild(p);

  row.appendChild(bubble);
  chatWindow.appendChild(row);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

async function sendQuestion() {
  if (!questionInput) return;

  const question = questionInput.value.trim();
  if (!question) return;

  appendMessage("user", question);

  questionInput.value = "";
  questionInput.disabled = true;
  sendBtn.disabled = true;
  sendBtn.textContent = "Thinking...";

  try {
    const response = await fetch(`${backendBaseUrl}/api/ask`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        class_level: classLevelSelect?.value,
        subject: subjectSelect?.value,
        chapter: chapterSelect?.value,
        question
      })
    });

    const data = await response.json();
    if (!response.ok) {
      appendMessage("bot", `Error: ${data.detail || "Something went wrong"}`);
    } else {
      appendMessage("bot", data.answer, data.meta);
    }
  } catch (err) {
    console.error(err);
    appendMessage("bot", "Network error. Please try again.");
  } finally {
    questionInput.disabled = false;
    sendBtn.disabled = false;
    sendBtn.textContent = "Ask";
    questionInput.focus();
  }
}

if (sendBtn) {
  sendBtn.addEventListener("click", sendQuestion);
}

if (questionInput) {
  questionInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendQuestion();
    }
  });
}

if (questionForm) {
  questionForm.addEventListener("submit", (e) => {
    e.preventDefault();
    sendQuestion();
  });
}
// ---------- Supabase client (if you use it on login/dashboard) ----------
// Keep or adjust as needed; safe even if not used on about.html.
const supabaseClient =
  typeof supabase !== "undefined"
    ? supabase.createClient(
        "https://ctquajydjitfjhqvezfz.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0cXVhanlkaml0ZmpocXZlemZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjA1MzQsImV4cCI6MjA4MzE5NjUzNH0.3cenuqB4XffJdRQisJQhq7PS9_ybXDN7ExbsKfXx9gU"
      )
    : null;

// ---------- Login (index.html) ----------

async function login(event) {
  if (!supabaseClient) return;
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  if (!emailInput || !passwordInput) return;

  event.preventDefault();

  const email = emailInput.value.trim();
  const password = passwordInput.value;

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    alert("❌ Wrong email or password");
  } else {
    window.location.href = "dashboard.html";
  }
}

// ---------- Chat helpers (dashboard.html) ----------

function appendMessage(role, text) {
  const chatWindow = document.getElementById("chatWindow");
  if (!chatWindow) return;

  const row = document.createElement("div");
  row.className = `message-row ${role}`;

  const bubble = document.createElement("div");
  bubble.className = "message-bubble";
  bubble.textContent = text;

  row.appendChild(bubble);
  chatWindow.appendChild(row);

  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function sendQuestion() {
  const input = document.getElementById("questionInput");
  const sendBtn = document.getElementById("sendBtn");
  const subject = document.getElementById("subject")?.value || "";
  const classLevel = document.getElementById("classLevel")?.value || "";
  const chapter = document.getElementById("chapter")?.value || "";

  if (!input || !sendBtn) return;

  const question = input.value.trim();
  if (!question) return;

  appendMessage("user", question);
  input.value = "";
  sendBtn.disabled = true;

  const fakeResponse =
    `Got it. I will explain this like an ICSE Class ${classLevel} ` +
    `${subject} teacher, focusing on chapter "${chapter || "General"}".`;

  setTimeout(() => {
    appendMessage("bot", fakeResponse);
    sendBtn.disabled = false;
  }, 600);
}

// ---------- Menu + Theme toggle (all pages) ----------

document.addEventListener("DOMContentLoaded", function () {
  const menuToggle = document.getElementById("menuToggle");
  const menuDropdown = document.getElementById("menuDropdown");
  const themeToggle = document.getElementById("themeToggle");

  // Restore theme
  const savedTheme = localStorage.getItem("theme");
  const initialTheme =
    savedTheme === "light" || savedTheme === "dark" ? savedTheme : "dark";
  document.body.setAttribute("data-theme", initialTheme);

  if (menuToggle && menuDropdown) {
    menuToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      menuDropdown.classList.toggle("open");
    });

    document.addEventListener("click", (e) => {
      if (
        !menuDropdown.contains(e.target) &&
        !menuToggle.contains(e.target)
      ) {
        menuDropdown.classList.remove("open");
      }
    });
  }

  if (themeToggle) {
    themeToggle.addEventListener("click", () => {
      const current = document.body.getAttribute("data-theme") || "dark";
      const next = current === "dark" ? "light" : "dark";
      document.body.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });
  }
});
